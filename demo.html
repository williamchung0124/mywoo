<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <title>地图找房</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body {
      background: #f5f6fa;
    }

    .filter-bar {
      background: #fff;
      border-bottom: 1px solid #e5e5e5;
      padding: 8px 16px;
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
    }

    .filter-bar .btn,
    .filter-bar .dropdown {
      margin-right: 8px;
      min-width: 80px;
    }

    .filter-bar .btn.active,
    .filter-bar .btn-primary {
      background: #1e7efb;
      color: #fff;
    }

    .filter-bar .btn-outline-primary {
      border-color: #1e7efb;
      color: #1e7efb;
    }

    .filter-bar .btn-outline-primary:hover {
      background: #1e7efb;
      color: #fff;
    }

    .main-content {
      display: flex;
    }

    .map-container {
      flex: 1 1 0;
      min-width: 0;
      height: 700px;
    }

    .house-list {
      width: 420px;
      background: #fff;
      border-left: 1px solid #e5e5e5;
      overflow-y: auto;
      max-height: 700px;
    }

    .house-card {
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      padding: 12px;
    }

    .house-card img {
      width: 110px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      margin-right: 12px;
    }

    .house-card .card-body {
      padding: 0;
    }

    .house-card .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .house-card .card-text {
      font-size: 14px;
      color: #666;
    }

    .house-card .price {
      color: #e94d3a;
      font-weight: bold;
      font-size: 18px;
    }

    .pagination {
      margin: 16px 0;
    }

    /* 移动端适配 */
    @media (max-width: 991px) {
      .header {
        display: none;
      }

      .header-bar {
        display: flex;
      }

      .main-content {
        flex-direction: column;
      }

      .map-container,
      .house-list {
        width: 100%;
        height: 320px;
        max-height: 320px;
      }

      .house-list {
        border-left: none;
        border-top: 1px solid #e5e5e5;
      }

      .filter-bar {
        padding: 8px 4px;
      }
    }

    /* 滚动条美化 */
    .house-list::-webkit-scrollbar {
      width: 6px;
      background: #f0f0f0;
    }

    .house-list::-webkit-scrollbar-thumb {
      background: #e0e0e0;
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <div class="el-containers">
    <!-- PC头部 -->
   
    <!-- 移动端头部 -->
    
    <!-- 筛选栏 -->
    <div class="filter-bar">
      <select class="form-select me-2" id="filterCity" style="width:120px;"></select>
      <select class="form-select me-2" id="filterType" style="width:100px;"></select>
      <select class="form-select me-2" id="filterPrice" style="width:100px;"></select>
      <select class="form-select me-2" id="filterArea" style="width:100px;"></select>
      <select class="form-select me-2" id="filterMore" style="width:100px;"></select>
      <button class="btn btn-link text-danger ms-auto" id="clearFilter">清空條件</button>
    </div>
    <!-- 主体内容 -->
    <div class="container-fluid px-0">
      <div class="main-content">
        <!-- 地图 -->
        <div class="map-container" id="map"></div>
        <!-- 房源列表 -->
        <div class="house-list" id="houseList">
          <!-- 房源卡片和分页由JS动态生成 -->
        </div>
      </div>
    </div>
  </div>
  <!-- 依赖 -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- 高德地图API（请替换成你自己的key） -->
  <script src="https://webapi.amap.com/maps?v=2.0&key=6c0e1b6b6e2e2e2e2e2e2e2e2e2e2e2e"></script>
  <script>
    // 假数据生成
    const cityList = ["高雄市", "台北市", "台中市"];
    const typeList = ["公寓", "大樓", "透天"];
    const priceList = [
      { value: '0-500', label: '0-500萬' },
      { value: '500-1000', label: '500-1000萬' },
      { value: '1000+', label: '1000萬以上' }
    ];
    const areaList = [
      { value: '0-30', label: '0-30坪' },
      { value: '30-60', label: '30-60坪' },
      { value: '60+', label: '60坪以上' }
    ];
    const moreList = ["有車位", "近捷運", "新成屋"];
    const tagList = ["推薦", "精選", "疑似凶宅", ""];
    const auctionRounds = ["一拍", "二拍", "三拍"];
    const ownerList = [
      { name: "吳美慧", avatar: "https://randomuser.me/api/portraits/women/68.jpg" },
      { name: "陳麗環", avatar: "https://randomuser.me/api/portraits/women/65.jpg" },
      { name: "張大明", avatar: "https://randomuser.me/api/portraits/men/32.jpg" }
    ];
    // 随机生成经纬度（高雄附近）
    function randomMarker(city) {
      let base = {"高雄市": [120.3, 22.63], "台北市": [121.5, 25.05], "台中市": [120.67, 24.15]};
      let [lng, lat] = base[city];
      return [lng + (Math.random() - 0.5) * 0.1, lat + (Math.random() - 0.5) * 0.1];
    }
    function randomPrice() {
      const n = Math.floor(Math.random() * 1600) + 100; // 100~1700
      return n;
    }
    function randomArea() {
      const n = Math.floor(Math.random() * 90) + 10; // 10~100
      return n;
    }
    const houseData = Array.from({length: 50}, (_, i) => {
      const city = cityList[Math.floor(Math.random()*cityList.length)];
      const type = typeList[Math.floor(Math.random()*typeList.length)];
      const price = randomPrice();
      const area = randomArea();
      const more = moreList[Math.floor(Math.random()*moreList.length)];
      const tag = tagList[Math.floor(Math.random()*tagList.length)];
      const owner = ownerList[Math.floor(Math.random()*ownerList.length)];
      const auction = auctionRounds[Math.floor(Math.random()*auctionRounds.length)];
      const age = Math.floor(Math.random()*40)+1; // 屋齡1-40年
      const hasParking = Math.random() > 0.5;
      return {
        id: i+1,
        title: `${city}${type}物件${i+1}`,
        img: `https://placehold.co/180x120?text=房${i+1}`,
        price: price,
        area: area,
        floor: `${1+Math.floor(Math.random()*10)}F/${5+Math.floor(Math.random()*10)}F`,
        address: `${city}XX路${10+i}號`,
        openDate: `114/05/${(5 + (i%25)).toString().padStart(2,'0')}`,
        tag: tag,
        marker: randomMarker(city),
        city, type, more,
        owner, auction, age, hasParking
      };
    });
    let currentPage = 1, pageSize = 6;
    let filteredData = houseData;

    // 根据筛选条件过滤数据
    function filterHouseData() {
      const city = $('#filterCity').val();
      const type = $('#filterType').val();
      const price = $('#filterPrice').val();
      const area = $('#filterArea').val();
      const more = $('#filterMore').val();
      filteredData = houseData.filter(house => {
        let ok = true;
        if (city && house.city !== city) ok = false;
        if (type && house.type !== type) ok = false;
        if (price) {
          if (price === '0-500' && !(house.price >= 0 && house.price <= 500)) ok = false;
          if (price === '500-1000' && !(house.price > 500 && house.price <= 1000)) ok = false;
          if (price === '1000+' && !(house.price > 1000)) ok = false;
        }
        if (area) {
          if (area === '0-30' && !(house.area >= 0 && house.area <= 30)) ok = false;
          if (area === '30-60' && !(house.area > 30 && house.area <= 60)) ok = false;
          if (area === '60+' && !(house.area > 60)) ok = false;
        }
        if (more && house.more !== more) ok = false;
        return ok;
      });
    }

    // 渲染房源列表
    function renderHouseList(page = 1) {
      const start = (page - 1) * pageSize;
      const end = start + pageSize;
      const list = filteredData.slice(start, end);
      let html = '';
      function getPriceLabel(val) {
        if (val <= 500) return '0-500萬';
        if (val > 500 && val <= 1000) return '500-1000萬';
        if (val > 1000) return '1000萬以上';
        return val + '萬';
      }
      function getAreaLabel(val) {
        if (val <= 30) return '0-30坪';
        if (val > 30 && val <= 60) return '30-60坪';
        if (val > 60) return '60坪以上';
        return val + '坪';
      }
      list.forEach(house => {
        html += `
        <div class="house-card d-flex py-3 px-2 align-items-start border-bottom position-relative">
          <div class="me-3 flex-shrink-0" style="width: 180px;">
            <img src="${house.img}" alt="" class="rounded-3 w-100" style="height:120px;object-fit:cover;">
            ${house.tag ? `<span class="badge bg-primary position-absolute top-0 start-0 m-2">${house.tag}</span>` : ''}
          </div>
          <div class="card-body p-0 flex-grow-1">
            <div class="d-flex align-items-center mb-1">
              <div class="card-title fw-bold fs-5 mb-0 text-truncate" style="max-width:70%">${house.title}</div>
              <span class="ms-2 text-secondary small">${house.type}</span>
            </div>
            <div class="mb-1 text-secondary small">
              坪數 ${house.area}｜${house.type}｜${house.floor}｜屋齡 ${house.age}年${house.hasParking ? '｜有車位' : ''}
            </div>
            <div class="mb-1 text-secondary small">
              <i class="bi bi-geo-alt"></i> ${house.address}
            </div>
            <div class="mb-1">
              <span class="badge bg-light text-primary border me-1">開標日：${house.openDate}</span>
              <span class="badge bg-light text-primary border me-1">${house.auction}</span>
              ${house.tag === '疑似凶宅' ? '<span class="badge bg-danger text-white">疑似凶宅</span>' : ''}
            </div>
            <div class="d-flex align-items-center mt-2">
              <img src="${house.owner.avatar}" class="rounded-circle me-2" width="32" height="32" alt="${house.owner.name}">
              <span class="me-3 text-secondary small">代標顧問 ${house.owner.name}</span>
              <span class="fw-bold fs-4 text-danger">總價 ${house.price} 萬</span>
              <span class="ms-3 text-secondary small">單價 ${(house.price/house.area).toFixed(1)}萬/坪</span>
            </div>
          </div>
        </div>
        `;
      });
      // 分页
      const totalPage = Math.ceil(filteredData.length / pageSize);
      function getPagination(current, total) {
        let pages = [];
        if (total <= 7) {
          for (let i = 1; i <= total; i++) pages.push(i);
        } else {
          if (current > 4) pages.push(1);
          if (current > 5) pages.push('prev-ellipsis');
          for (let i = Math.max(2, current - 2); i <= Math.min(total - 1, current + 2); i++) {
            pages.push(i);
          }
          if (current < total - 4) pages.push('next-ellipsis');
          if (current < total - 3) pages.push(total);
        }
        return pages;
      }
      const pages = getPagination(page, totalPage);
      html += `<nav><ul class="pagination pagination-sm justify-content-center align-items-center">`;
      // 上一页
      html += `<li class="page-item${page === 1 ? ' disabled' : ''}"><a class="page-link" href="#" data-page="prev">&lt;</a></li>`;
      // 页码
      pages.forEach(p => {
        if (p === 'prev-ellipsis' || p === 'next-ellipsis') {
          html += `<li class="page-item disabled"><span class="page-link">&hellip;</span></li>`;
        } else {
          html += `<li class="page-item${p === page ? ' active' : ''}"><a class="page-link" href="#" data-page="${p}">${p}</a></li>`;
        }
      });
      // 下一页
      html += `<li class="page-item${page === totalPage ? ' disabled' : ''}"><a class="page-link" href="#" data-page="next">&gt;</a></li>`;
      html += `</ul></nav>`;
      // 分页栏样式优化
      html += `<style>
        .house-card .badge.bg-primary {background:#1e7efb!important;}
        .house-card .badge.bg-danger {background:#e94d3a!important;}
        .pagination .page-link {border-radius:8px;margin:0 2px;}
        .pagination .active .page-link {background:#1e7efb;border-color:#1e7efb;}
      </style>`;
      $('#houseList').html(html);
    }

    // 地图初始化
    let map, markers = [];
    function initMap() {
      map = new AMap.Map('map', {
        center: [120.301, 22.627],
        zoom: 12,
        resizeEnable: true
      });
      renderMarkers();
    }
    function renderMarkers() {
      markers.forEach(m => map.remove(m));
      markers = [];
      // 统计每个区域的房源数量
      const areaCount = {};
      filteredData.forEach(house => {
        areaCount[house.city] = (areaCount[house.city] || 0) + 1;
      });
      // 只保留每个区域第一个房源的marker，显示区域和数量
      const cityMarkers = {};
      filteredData.forEach((house, idx) => {
        if (!cityMarkers[house.city]) {
          const count = areaCount[house.city];
          const marker = new AMap.Marker({
            position: house.marker,
            map: map,
            label: {
              content: `<div class='custom-cluster-label'>
                <div class='cluster-circle'>
                  <div class='cluster-title'>${house.city}</div>
                  <div class='cluster-count'>${count}間</div>
                </div>
              </div>`,
              offset: new AMap.Pixel(-45, -45)
            }
          });
          marker.on('click', function () {
            $('#filterCity').val(house.city).trigger('change');
          });
          markers.push(marker);
          cityMarkers[house.city] = true;
        }
      });
    }

    // 插入气泡样式
    if (!document.getElementById('cluster-label-style')) {
      const style = document.createElement('style');
      style.id = 'cluster-label-style';
      style.innerHTML = `
        .custom-cluster-label .cluster-circle {
          width: 90px;
          height: 90px;
          background: rgba(168, 92, 200, 0.7);
          border-radius: 50%;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          box-shadow: 0 2px 12px rgba(0,0,0,0.18);
        }
        .custom-cluster-label .cluster-title {
          color: #fff;
          font-size: 20px;
          font-weight: bold;
          text-shadow: 0 2px 6px rgba(0,0,0,0.25);
          margin-bottom: 2px;
        }
        .custom-cluster-label .cluster-count {
          color: #fff;
          font-size: 18px;
          font-weight: 500;
          text-shadow: 0 2px 6px rgba(0,0,0,0.25);
        }
      `;
      document.head.appendChild(style);
    }

    // 动态生成筛选栏option
    function renderFilterOptions() {
      // 城市
      let cityOpt = cityList.map(city => `<option value="${city}">${city}</option>`).join('');
      $('#filterCity').html(cityOpt);
      // 类型
      let typeOpt = '<option value="">類型</option>' + typeList.map(type => `<option value="${type}">${type}</option>`).join('');
      $('#filterType').html(typeOpt);
      // 总价
      let priceOpt = '<option value="">總價</option>' + priceList.map(p => `<option value="${p.value}">${p.label}</option>`).join('');
      $('#filterPrice').html(priceOpt);
      // 坪数
      let areaOpt = '<option value="">坪數</option>' + areaList.map(a => `<option value="${a.value}">${a.label}</option>`).join('');
      $('#filterArea').html(areaOpt);
      // 更多
      let moreOpt = '<option value="">更多</option>' + moreList.map(m => `<option value="${m}">${m}</option>`).join('');
      $('#filterMore').html(moreOpt);
    }

    // 监听筛选栏 select 变化
    $('.filter-bar select').on('change', function () {
      filterHouseData();
      renderHouseList(1);
      renderMarkers();
    });
    // 清空筛选
    $('#clearFilter').on('click', function () {
      $('#filterCity').val('高雄市');
      $('#filterType').val('');
      $('#filterPrice').val('');
      $('#filterArea').val('');
      $('#filterMore').val('');
      filterHouseData();
      renderHouseList(1);
      renderMarkers();
    });

    // 分页交互
    $('#houseList').on('click', '.page-link', function (e) {
      e.preventDefault();
      let page = $(this).data('page');
      if (page === 'prev') page = currentPage - 1;
      else if (page === 'next') page = currentPage + 1;
      else page = parseInt(page);
      if (page && page !== currentPage && page >= 1 && page <= Math.ceil(filteredData.length / pageSize)) {
        currentPage = page;
        renderHouseList(page);
      }
    });

    // 房源卡片点击高亮marker
    $('#houseList').on('click', '.house-card', function () {
      const id = parseInt($(this).data('id'));
      const idx = filteredData.findIndex(h => h.id === id);
      if (idx !== -1) {
        map.setZoomAndCenter(15, filteredData[idx].marker);
        markers[idx].setAnimation('AMAP_ANIMATION_BOUNCE');
        setTimeout(() => markers[idx].setAnimation('AMAP_ANIMATION_NONE'), 1200);
      }
    });

    // 初始化
    $(function () {
      renderFilterOptions();
      filterHouseData();
      renderHouseList(1);
      initMap();
    });
  </script>
</body>

</html>